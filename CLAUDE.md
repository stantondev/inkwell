# Inkwell — Claude Code Context

## What is Inkwell?

A federated social journaling platform — LiveJournal meets MySpace, reimagined for 2026 with ActivityPub federation. No algorithms, no ads, user-owned spaces.

## Architecture

- **Backend**: Elixir/Phoenix 1.8 API (`apps/api/`) — OTP release deployed to Fly.io
- **Frontend**: Next.js 16 + React (`apps/web/`) — standalone output deployed to Fly.io
- **Federation**: Fedify ActivityPub sidecar (`services/federation/`) — Node.js, NOT yet deployed
- **Database**: PostgreSQL 16 (Fly Postgres, `inkwell-db`)
- **Search**: Meilisearch — NOT yet deployed to production
- **Cache**: Redis (Upstash via Fly) — provisioned but has TLS connection issues; auth was migrated OFF Redis to Postgres
- **Email**: Resend API for transactional emails (magic link auth)

## Monorepo Structure

npm workspaces monorepo. Lock file lives at root, NOT in individual apps.

```
inkwell/
  apps/
    api/          # Elixir/Phoenix backend (mix project, NOT in npm workspace)
    web/          # Next.js frontend (npm workspace member)
  services/
    federation/   # Fedify ActivityPub sidecar (npm workspace member)
  packages/
    types/        # Shared TypeScript types (npm workspace member)
```

## Deployment (Fly.io)

### Live URLs
- **Frontend**: https://inkwell-web.fly.dev
- **API**: https://inkwell-api.fly.dev
- **Health check**: https://inkwell-api.fly.dev/health

### Deploy commands
```bash
fly deploy --config fly.api.toml --wait-timeout 600   # API only
fly deploy --config fly.web.toml --wait-timeout 600   # Web only
./deploy.sh                                            # Full deploy (first-time)
```

### Fly secrets (inkwell-api)
- `DATABASE_URL` — set automatically by `fly postgres attach`
- `SECRET_KEY_BASE` — generated by deploy.sh
- `FRONTEND_URL` — `https://inkwell-web.fly.dev`
- `REDIS_URL` — Upstash Redis (has TLS issues, not actively used after auth migration)
- `RESEND_API_KEY` — for sending magic link emails

### Fly secrets (inkwell-web)
- `API_URL` — set in fly.web.toml env section as `https://inkwell-api.fly.dev`
- `NEXT_PUBLIC_API_URL` — set as build arg in fly.web.toml

### Docker builds
- API Dockerfile at `apps/api/Dockerfile` — build context is **project root**, paths use `apps/api/` prefix
- Web Dockerfile at `apps/web/Dockerfile` — build context is **project root**, uses `npm ci --workspace=apps/web`
- Next.js standalone output nests server.js at `apps/web/server.js` inside standalone dir (workspace monorepo behavior)
- Docker entrypoint runs Ecto migrations automatically on deploy

## Authentication System

Magic link email auth, fully backed by Postgres (NOT Redis):

1. User enters email at `/login`
2. `POST /api/auth/magic-link` → creates user if needed → creates token in `auth_tokens` table → sends email via Resend API
3. If `RESEND_API_KEY` is not set, falls back to "dev mode" — returns magic link in the JSON response, frontend shows it on screen
4. User clicks magic link → `GET /auth/verify?token=...` (Next.js route handler) → calls `GET /api/auth/verify?token=...` on Phoenix → verifies token, creates API session token → sets httpOnly cookie → redirects to `/feed`
5. Authenticated requests use Bearer token in Authorization header, verified against `auth_tokens` table

### Key files
- `apps/api/lib/inkwell/auth.ex` — token CRUD (create, verify, revoke)
- `apps/api/lib/inkwell/auth/auth_token.ex` — Ecto schema for `auth_tokens` table
- `apps/api/lib/inkwell/email.ex` — Resend API email sending via :httpc
- `apps/api/lib/inkwell_web/controllers/auth_controller.ex` — login/verify/signout endpoints
- `apps/api/lib/inkwell_web/plugs/require_auth.ex` — Bearer token + session auth plug
- `apps/web/src/app/login/page.tsx` — login UI
- `apps/web/src/app/auth/verify/route.ts` — server-side token verification + cookie setting

## Known Issues & TODO

### Critical
- **Redis TLS connection still broken** — Upstash requires TLS, Redix connection fails with `ConnectionError{reason: :closed}`. Auth was migrated to Postgres to work around this. Other features that use Redis (if any) may still be affected. The Redix pool still starts in `application.ex` and may log errors.
- **Federation service not deployed** — `services/federation/` (Fedify/Node.js) has no Fly.io config yet
- **Meilisearch not deployed** — search functionality won't work in production
- **Resend email "from" domain** — currently uses `onboarding@resend.dev` (Resend test sender). Need to verify a custom domain in Resend dashboard for production emails from `@inkwell.social`

### Important
- **No email sending verification** — should confirm Resend emails are actually being delivered (check Resend dashboard)
- **Token cleanup** — `Inkwell.Auth.cleanup_expired_tokens/0` exists but is not scheduled (should add an Oban job)
- **CORS** — runtime CORS plug reads from config; verify it works correctly between inkwell-web.fly.dev and inkwell-api.fly.dev
- **`force_ssl` removed** — was causing health check 301 loops. Fly terminates TLS at the edge, but consider adding HSTS headers

### Nice to Have
- **CI/CD** — `.github/workflows/deploy.yml` exists but needs `FLY_API_TOKEN` secret set in GitHub repo settings
- **Remove unused Redis code** — `apps/api/lib/inkwell/redis.ex` and Redix pool in `application.ex` can be cleaned up since auth no longer uses Redis
- **Custom domain** — both apps currently on `*.fly.dev` subdomains
- **ARM64 packages** — were removed from `apps/web/package.json` to fix Fly x64 builds; if developing on Apple Silicon, `npm install` will add them back to lockfile

## Development Notes

### Running locally
```bash
docker compose up -d          # Start Postgres, Redis, Meilisearch
cd apps/api && mix setup && mix phx.server
npm run dev:web               # In another terminal
```

### Important patterns
- Phoenix uses runtime.exs for all production config (env vars read at boot, not compile time)
- CORS origins configured at runtime via custom plug (`InkwellWeb.Plugs.CORS`)
- Users have UUID primary keys (`binary_id`)
- RSA keypairs auto-generated on user registration (for ActivityPub federation)
- Oban for background jobs
