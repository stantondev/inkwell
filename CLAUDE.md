# Inkwell — Claude Code Context

## What is Inkwell?

A federated social journaling platform — LiveJournal meets MySpace, reimagined for 2026 with ActivityPub federation. No algorithms, no ads, user-owned spaces.

## Architecture

- **Backend**: Elixir/Phoenix 1.8 API (`apps/api/`) — OTP release deployed to Fly.io
- **Frontend**: Next.js 16 + React (`apps/web/`) — standalone output deployed to Fly.io
- **Federation**: Fedify ActivityPub sidecar (`services/federation/`) — Node.js, NOT yet deployed
- **Database**: PostgreSQL 16 (Fly Postgres, `inkwell-db`)
- **Search**: Meilisearch — NOT yet deployed to production
- **Cache**: Redis (Upstash via Fly) — provisioned but has TLS connection issues; auth was migrated OFF Redis to Postgres
- **Email**: Resend API for transactional emails (magic link auth)

## Monorepo Structure

npm workspaces monorepo. Lock file lives at root, NOT in individual apps.

```
inkwell/
  apps/
    api/          # Elixir/Phoenix backend (mix project, NOT in npm workspace)
    web/          # Next.js frontend (npm workspace member)
  services/
    federation/   # Fedify ActivityPub sidecar (npm workspace member)
  packages/
    types/        # Shared TypeScript types (npm workspace member)
```

## Deployment (Fly.io)

### Live URLs
- **Frontend**: https://inkwell-web.fly.dev
- **API**: https://inkwell-api.fly.dev
- **Health check**: https://inkwell-api.fly.dev/health

### Deploy commands
```bash
fly deploy --config fly.api.toml --wait-timeout 600   # API only
fly deploy --config fly.web.toml --wait-timeout 600   # Web only
./deploy.sh                                            # Full deploy (first-time)
```

### Fly secrets (inkwell-api)
- `DATABASE_URL` — set automatically by `fly postgres attach`
- `SECRET_KEY_BASE` — generated by deploy.sh
- `FRONTEND_URL` — `https://inkwell-web.fly.dev`
- `REDIS_URL` — Upstash Redis (has TLS issues, not actively used after auth migration)
- `RESEND_API_KEY` — for sending magic link emails
- `ADMIN_USERNAMES` — comma-separated list of usernames that get admin access
- `STRIPE_SECRET_KEY` — Stripe API key for billing
- `STRIPE_WEBHOOK_SECRET` — Stripe webhook signing secret
- `STRIPE_PRICE_ID` — Stripe price ID for Plus subscription ($5/mo)

### Fly secrets (inkwell-web)
- `API_URL` — set in fly.web.toml env section as `https://inkwell-api.fly.dev`
- `NEXT_PUBLIC_API_URL` — set as build arg in fly.web.toml

### Docker builds
- API Dockerfile at `apps/api/Dockerfile` — build context is **project root**, paths use `apps/api/` prefix
- Web Dockerfile at `apps/web/Dockerfile` — build context is **project root**, uses `npm ci --workspace=apps/web`
- Next.js standalone output nests server.js at `apps/web/server.js` inside standalone dir (workspace monorepo behavior)
- Docker entrypoint runs Ecto migrations automatically on deploy

## Authentication System

Magic link email auth, fully backed by Postgres (NOT Redis):

1. User enters email at `/login`
2. `POST /api/auth/magic-link` → creates user if needed → creates token in `auth_tokens` table → sends email via Resend API
3. If `RESEND_API_KEY` is not set, falls back to "dev mode" — returns magic link in the JSON response, frontend shows it on screen
4. User clicks magic link → `GET /auth/verify?token=...` (Next.js route handler) → calls `GET /api/auth/verify?token=...` on Phoenix → verifies token, creates API session token → sets httpOnly cookie → redirects to `/feed`
5. Authenticated requests use Bearer token in Authorization header, verified against `auth_tokens` table

### Key files
- `apps/api/lib/inkwell/auth.ex` — token CRUD (create, verify, revoke)
- `apps/api/lib/inkwell/auth/auth_token.ex` — Ecto schema for `auth_tokens` table
- `apps/api/lib/inkwell/email.ex` — Resend API email sending via :httpc (also handles feedback emails)
- `apps/api/lib/inkwell_web/controllers/auth_controller.ex` — login/verify/signout/me endpoints; `render_user/1` returns session data including `subscription_tier` and `unread_notification_count`
- `apps/api/lib/inkwell_web/plugs/require_auth.ex` — Bearer token + session auth plug
- `apps/web/src/app/login/page.tsx` — login UI
- `apps/web/src/app/auth/verify/route.ts` — server-side token verification + cookie setting

## Implemented Features

### Journal Page-Turning UI
- CSS scroll-snap horizontal feed replaces vertical card list on feed/explore pages
- **Desktop**: 2-entry book spread (left + right pages with spine divider)
- **Mobile/Tablet**: single entry per snap page with swipe navigation
- Page counter ("3 — 12"), arrow navigation buttons, dot indicators
- Keyboard `ArrowLeft`/`ArrowRight` navigation
- Entrance animations via `motion` (Framer Motion v12+); respects `prefers-reduced-motion`
- Key frontend components:
  - `apps/web/src/components/journal-feed.tsx` — `"use client"` scroll-snap container; accepts `session` prop to enable interactive actions
  - `apps/web/src/components/journal-entry-card.tsx` — server component card; accepts `actions` prop (renders `FeedCardActions` when session is provided, static footer otherwise)
  - `apps/web/src/components/journal-page.tsx` — paper-textured page wrapper (`overflow-hidden`, so popups must use FloatingPopup portal)
  - `apps/web/src/components/page-navigation.tsx` — arrow buttons + dot indicators + keyboard handler
  - `apps/web/src/hooks/use-prefers-reduced-motion.ts` — detects OS reduced-motion preference
- Feed shows user's **own entries** + entries from **accepted follows** (not pending)
- Explore shows all public entries; uses `optional_auth` pipeline so authenticated users get `my_stamp`

### Stamps (Replacement for Likes)
- One stamp per reader per entry — no counts shown, only which types are present
- Cannot stamp own entries; "supporter" stamp requires Plus subscription
- 7 stamp types: `felt`, `holding_space`, `beautifully_said`, `rooting`, `throwback`, `i_cannot`, `supporter`
- Stamps display in top-right corner of entry cards (like a postage stamp on paper)
- Stamping another user's entry creates a `:stamp` notification for the author
- **Backend**:
  - `apps/api/lib/inkwell/stamps.ex` — context (create/update/delete stamp, get stamp types for entries, get user stamps for entries)
  - `apps/api/lib/inkwell/stamps/stamp.ex` — Ecto schema with unique constraint `[:user_id, :entry_id]`
  - Stamp routes: `POST /api/entries/:id/stamp`, `DELETE /api/entries/:id/stamp`, `GET /api/entries/:id/stamps`
  - Feed and explore controllers both query and return `stamps` (array of types present) and `my_stamp` (viewer's stamp)
- **Frontend**:
  - `apps/web/src/components/stamp-config.tsx` — `STAMP_CONFIG` map and `STAMP_TYPES` array (single source of truth)
  - `apps/web/src/components/stamp-display.tsx` — read-only stamp icons in card top-right
  - `apps/web/src/components/stamp-picker.tsx` — interactive stamp chooser; compact mode for feed cards, full mode for entry detail page; uses `FloatingPopup`
  - `apps/web/src/components/feed-card-actions.tsx` — `"use client"` footer for feed/explore cards: Read link + comment popup + stamp picker
  - Stamp SVG assets at `apps/web/public/stamps/*.svg` — swappable for artist illustrations

### Floating Popup (Portal-Based)
- `apps/web/src/components/floating-popup.tsx` — reusable React Portal popup component
- Uses `createPortal` to render at `document.body`, escaping `overflow-hidden` on `JournalPage` and `overflow-x: auto` on `.journal-scroll` (which forces `overflow-y: auto` per CSS spec)
- Uses `position: fixed` with coordinates from `getBoundingClientRect()` of anchor element
- Handles: outside click to close, scroll/resize repositioning, flip placement if near viewport edge, initial `visibility: hidden` to avoid flash
- Used by `FeedCardActions` (comment popup) and `StampPicker` (stamp dropdown) in both compact and full modes

### Unread Notification Badge
- `count_unread_notifications/1` in `Inkwell.Accounts` — counts unread notifications for a user
- Embedded in `GET /api/auth/me` response as `unread_notification_count`
- `SessionUser` type in `apps/web/src/lib/session.ts` includes `unread_notification_count?: number`
- **Desktop nav**: red badge with count (caps at "9+") on the bell icon in `apps/web/src/components/nav.tsx`
- **Mobile**: red dot on hamburger button + count badge next to "Notifications" in dropdown (`apps/web/src/components/mobile-menu.tsx`)

### Subscription / Billing (Stripe)
- Plus tier at $5/mo via Stripe Checkout
- `POST /api/billing/checkout` → creates Stripe Checkout session, returns URL
- `POST /api/billing/portal` → creates Stripe Customer Portal session
- `POST /api/billing/webhook` → handles Stripe webhook events (checkout.session.completed, invoice.payment_succeeded, customer.subscription.deleted)
- User model has: `stripe_customer_id`, `stripe_subscription_id`, `subscription_tier` ("free"/"plus"), `subscription_status`, `subscription_expires_at`
- `subscription_tier` is exposed via `render_user/1` in auth controller → available in `SessionUser` on frontend
- Frontend billing page: `apps/web/src/app/settings/billing/page.tsx`
- Nav shows "✦ Plus" pill for non-Plus users (desktop); mobile menu shows "Upgrade to Plus"
- Key files: `apps/api/lib/inkwell/billing.ex`, `apps/api/lib/inkwell_web/controllers/billing_controller.ex`

### Community Feedback & Roadmap Board
- Full public feedback board at `/roadmap` — replaces old email-only `/feedback`
- Users submit ideas, bugs, features, questions — stored in database with upvoting and comments
- Admin can set status (new → under_review → planned → in_progress → done → declined) and admin responses
- **Roadmap Kanban Panel** — 3-column board at top showing Under Review / Planned / In Progress items
- **Recently Shipped section** — completed items with admin-written release notes, crediting the original poster ("Suggested by @username")
- **Release notes** — admin writes a release note when marking status as "done"; auto-sets `completed_at` timestamp
- Upvoting (one per user per post, toggle), comments with delete
- Category filtering (bug/feature/idea/question), status filtering, sort (most_voted/newest/recently_updated)
- `/feedback` redirects to `/roadmap/new`
- Key backend files:
  - `apps/api/lib/inkwell/feedback/feedback_post.ex` — post schema with status/category enums, release_note, completed_at
  - `apps/api/lib/inkwell/feedback/feedback_vote.ex` — vote schema (unique per user+post)
  - `apps/api/lib/inkwell/feedback/feedback_comment.ex` — comment schema
  - `apps/api/lib/inkwell/feedback.ex` — context module (list_posts, toggle_vote, list_roadmap_items, list_release_notes, etc.)
  - `apps/api/lib/inkwell_web/controllers/feedback_controller.ex` — 10 actions (index, show, create, update, vote, unvote, create_comment, delete_comment, roadmap, releases)
  - `apps/api/lib/inkwell_web/plugs/optional_auth.ex` — assigns current_user if token present, doesn't halt
- Key frontend files:
  - `apps/web/src/app/roadmap/page.tsx` — main board with Kanban panel + Recently Shipped + post list
  - `apps/web/src/app/roadmap/[id]/page.tsx` — detail view with shipped attribution card
  - `apps/web/src/app/roadmap/new/page.tsx` — submit form
  - `apps/web/src/app/roadmap/[id]/admin-status-form.tsx` — admin controls with release note textarea
  - `apps/web/src/app/roadmap/badges.tsx` — StatusBadge, CategoryBadge components
  - `apps/web/src/app/roadmap/upvote-button.tsx` — optimistic upvote client component
- API proxy routes: `apps/web/src/app/api/feedback/` (route.ts, [id]/route.ts, [id]/vote/route.ts, [id]/comments/route.ts, comments/[id]/route.ts, roadmap/route.ts, releases/route.ts)

### Top 6 Pen Pals
- Users can pick up to 6 "top friends" shown on their profile sidebar
- `PUT /api/me/top-friends` to save, `GET /api/me/top-friends` to list
- Key files: `apps/api/lib/inkwell/social/top_friend.ex`, `apps/web/src/app/settings/top-friends/page.tsx`

### Account Deletion
- Self-serve account deletion from Settings → Profile page (Danger Zone section)
- Confirmation modal requires typing username to confirm
- Cancels Stripe subscription if active before deleting
- DB cascading foreign keys delete all associated data (entries, stamps, relationships, notifications, auth tokens, top friends, votes)
- Comments and feedback posts are preserved anonymously (`user_id` set to NULL via `nilify_all`)
- Clears session cookie and redirects to home page after deletion
- **Backend**: `Inkwell.Accounts.delete_account/1`, `Inkwell.Billing.cancel_subscription/1`, `DELETE /api/me` in UserController
- **Frontend**: `apps/web/src/app/settings/danger-zone.tsx` (client component), proxy route in `apps/web/src/app/api/me/route.ts`
- **Migration**: `20260222000003` — allows NULL `user_id` on `feedback_posts` and `feedback_comments` for nilify cascade

### Mobile Navigation
- Hamburger menu (☰) on screens < 640px with all nav links
- Client component at `apps/web/src/components/mobile-menu.tsx`
- Integrated in `apps/web/src/components/nav.tsx`

### Other Features
- **Journal entries**: CRUD with title, body (Markdown→HTML), mood, music, tags, visibility
- **Comments**: threaded on entries; feed cards have inline comment popup via `FeedCardActions`
- **Relationships**: follow/accept/reject/block with pending state
- **Notifications**: follow, comment, entry, stamp notifications; unread badge in nav
- **Tag pages**: `/tag/[tag]` — public entries filtered by tag
- **Explore**: public discovery feed; optional auth for personalized `my_stamp` data
- **Search**: text search (requires Meilisearch — not deployed to prod yet)
- **RSS feeds**: per-user and per-tag RSS XML feeds
- **Music player**: embedded music links on entries
- **Profile pages**: avatar, bio, pronouns, Plus badge, Top Pen Pals sidebar, entry list
- **Admin panel**: entry listing/deletion at `/admin` (requires `ADMIN_USERNAMES` Fly secret)
- **ActivityPub federation**: WebFinger, actor endpoints, inbox/outbox, HTTP signatures (sidecar not deployed)
- **Onboarding**: `/welcome` flow for new users (set display name, username, bio)
- **Landing page**: public homepage with feature showcase and pricing (Plus tier shown as live)

## Navigation Structure

### Desktop (≥640px)
- **Left**: Inkwell logo → `/`
- **Center**: Feed, Explore, Pen Pals, Search, Roadmap, ✦ Plus (if free), Admin (if admin)
- **Right**: Write button, Notifications bell (with unread badge), Profile avatar, Settings gear, Sign out

### Mobile (<640px)
- **Left**: Inkwell logo
- **Right**: Hamburger menu (☰, with red dot when unread notifications), Profile avatar
- **Hamburger dropdown**: Feed, Explore, Pen Pals, Write, Notifications (with count badge), Search, Roadmap, Profile, Settings, Upgrade to Plus (if free), Admin (if admin)

### Settings Tabs
Profile | Pen Pals | Top 6 | Billing | Roadmap

## Database Tables
- `users` — accounts with UUID PKs, Stripe fields, AP keys
- `entries` — journal entries with slug, title, body_html, body_raw, mood, music, tags, visibility
- `comments` — on entries, with user_id and body
- `relationships` — follow/friend/block between users (status: pending/accepted/blocked)
- `top_friends` — user_id + friend_id + position (1-6)
- `notifications` — type (follow/comment/entry/stamp), actor_id, target_id, entry_id, read flag
- `stamps` — entry_id + user_id + stamp_type; unique on [user_id, entry_id]
- `user_icons` — custom profile icons
- `friend_filters` — reading filters
- `auth_tokens` — magic link + API session tokens (type, token, user_id, expires_at)
- `remote_actors` — ActivityPub remote user cache
- `feedback_posts` — community feedback with title, body, category, status, admin_response, release_note, completed_at, vote_count, comment_count
- `feedback_votes` — user_id + feedback_post_id (unique together)
- `feedback_comments` — body, user_id, feedback_post_id
- `oban_jobs` / `oban_peers` — background job queue

## Known Issues & TODO

### Critical
- **Redis TLS connection still broken** — Upstash requires TLS, Redix connection fails with `ConnectionError{reason: :closed}`. Auth was migrated to Postgres to work around this. Other features that use Redis (if any) may still be affected. The Redix pool still starts in `application.ex` and may log errors.
- **Federation service not deployed** — `services/federation/` (Fedify/Node.js) has no Fly.io config yet
- **Meilisearch not deployed** — search functionality won't work in production
- **Resend email "from" domain** — currently uses `onboarding@resend.dev` (Resend test sender). Need to verify a custom domain in Resend dashboard for production emails from `@inkwell.social`

### Important
- **No email sending verification** — should confirm Resend emails are actually being delivered (check Resend dashboard)
- **Token cleanup** — `Inkwell.Auth.cleanup_expired_tokens/0` exists but is not scheduled (should add an Oban job)
- **CORS** — runtime CORS plug reads from config; verify it works correctly between inkwell-web.fly.dev and inkwell-api.fly.dev
- **`force_ssl` removed** — was causing health check 301 loops. Fly terminates TLS at the edge, but consider adding HSTS headers

### Nice to Have
- **CI/CD** — `.github/workflows/deploy.yml` exists but needs `FLY_API_TOKEN` secret set in GitHub repo settings
- **Remove unused Redis code** — `apps/api/lib/inkwell/redis.ex` and Redix pool in `application.ex` can be cleaned up since auth no longer uses Redis
- **Custom domain** — both apps currently on `*.fly.dev` subdomains
- **ARM64 packages** — were removed from `apps/web/package.json` to fix Fly x64 builds; if developing on Apple Silicon, `npm install` will add them back to lockfile

## Development Notes

### Running locally
```bash
docker compose up -d          # Start Postgres, Redis, Meilisearch
cd apps/api && mix setup && mix phx.server
npm run dev:web               # In another terminal
```

### Important patterns
- Phoenix uses runtime.exs for all production config (env vars read at boot, not compile time)
- CORS origins configured at runtime via custom plug (`InkwellWeb.Plugs.CORS`)
- Users have UUID primary keys (`binary_id`)
- RSA keypairs auto-generated on user registration (for ActivityPub federation)
- Oban for background jobs
- All styling uses CSS custom variables (`var(--accent)`, `var(--surface)`, `var(--border)`, `var(--muted)`, `var(--foreground)`, etc.)
- Rounded cards with border styling: `rounded-xl border p-4` + `borderColor: var(--border)` + `background: var(--surface)`
- Fonts: Lora (serif) for headings, system sans-serif for body
- **Popups must use `FloatingPopup`** — `JournalPage` has `overflow-hidden` and `.journal-scroll` has `overflow-x: auto` (forces `overflow-y: auto`). Any absolutely-positioned dropdown/popup inside the feed must use the `FloatingPopup` portal component or it will be clipped.

## Workflow Preferences

### Git & Deploy
- **Always commit, push, and deploy for me** — after completing features, commit all changes, push to `main`, and deploy both API and web to Fly.io
- **GitHub repo**: https://github.com/stantondev/inkwell.git (remote: `origin`, branch: `main`)
- **Deploy order**: API first (runs migrations automatically via Docker entrypoint), then web. Use `fly deploy --config fly.api.toml --wait-timeout 600` and `fly deploy --config fly.web.toml --wait-timeout 600`
- **Verify after deploy**: hit `/health` on API, check new endpoints return expected shape, check frontend pages return 200
- **TypeScript check before deploy**: `npx tsc --noEmit --project apps/web/tsconfig.json`
- **No local Elixir/Mix**: the dev machine does NOT have Elixir installed — cannot run `mix compile` locally. Do careful code review instead, and rely on the Docker build catching compile errors

### Migration naming
- Format: `YYYYMMDD######` — e.g., `20260222000002_create_stamps.exs`
- Latest migration: `20260222000003_allow_null_user_on_feedback.exs`

### Code style
- CSS custom variables for all colors (never hardcode colors except in badge configs)
- Rounded cards: `rounded-xl border p-4` with `borderColor: var(--border)` and `background: var(--surface)`
- Serif font for headings: `fontFamily: "var(--font-lora, Georgia, serif)"`
- System sans-serif for body text
- UUIDs everywhere (`binary_id` in Ecto, `string` in TypeScript)
- Ecto.Enum for status/type fields
- `apiFetch()` for server components, regular `fetch()` for client components via API proxy routes
- Next.js 16 uses `searchParams` and `params` as Promises in page components
